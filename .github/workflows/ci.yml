name: CI - Deep Explorer Mode - 20 Websites

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-websites-deep:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    strategy:
      fail-fast: false
      max-parallel: 4  # Run 4 at a time to avoid rate limits
      matrix:
        website:
          # 20 Working Websites for Deep Exploration
          
          # E-commerce Sites
          - name: saucedemo_ecommerce
            url: "https://www.saucedemo.com/"
            goal: "Login as 'standard_user'/'secret_sauce', add 'Backpack' to cart, checkout with zip='90210', verify order confirmation"
            
          - name: automationexercise_shop
            url: "https://www.automationexercise.com/"
            goal: "Click 'Products', click FIRST product, add to cart, verify cart shows 1 item"
            
          - name: "demoblaze_store"
            url: "https://www.demoblaze.com/"
            goal: "Browse products and test purchase flow"
            
          - name: rahulshetty_shop
            url: "https://rahulshettyacademy.com/seleniumPractise/"
            goal: "Search for 'Brocolli', add FIRST result to cart, click cart icon, verify checkout button visible"
            
          # Banking & Finance
          - name: "parabank_banking"
            url: "https://parabank.parasoft.com/"
            goal: "Test banking operations"
            
          - name: "globalsqa_bank"
            url: "https://www.globalsqa.com/angularJs-protractor/BankingProject/"
            goal: "Customer and manager banking flows"
            
          # Forms & UI Testing
          - name: "demoqa_practice"
            url: "https://demoqa.com/"
            goal: "Test various form elements"
            
          - name: "the_internet_forms"
            url: "https://the-internet.herokuapp.com/"
            goal: "Test authentication and forms"
            
          - name: "seleniumeasy_forms"
            url: "https://demo.seleniumeasy.com/basic-first-form-demo.html"
            goal: "Validate input forms"
            
          # HR & Management
          - name: "orangehrm_demo"
            url: "https://opensource-demo.orangehrmlive.com/"
            goal: "Test HR management features"
            
          # Travel & Booking
          - name: "phptravels_demo"
            url: "https://phptravels.com/demo/"
            goal: "Explore travel booking"
            
          - name: "blazedemo_travel"
            url: "https://blazedemo.com/"
            goal: "Book a flight"
            
          # Testing Practice Sites
          - name: "saucedemo_locked"
            url: "https://www.saucedemo.com/"
            goal: "Test locked user scenarios"
            
          - name: "automation_practice"
            url: "http://www.automationpractice.pl/"
            goal: "Practice automation scenarios"
            
          - name: "uitestingplayground"
            url: "http://uitestingplayground.com/"
            goal: "Test UI interactions"
            
          # CMS & Admin
          - name: "wordpress_demo"
            url: "https://tastewp.com/new"
            goal: "Quick WordPress testing"
            
          # API & Tool Testing
          - name: "reqres_api_ui"
            url: "https://reqres.in/"
            goal: "Explore API documentation UI"
            
          - name: "petstore_swagger"
            url: "https://petstore.swagger.io/"
            goal: "Test Swagger UI interactions"
            
          # Miscellaneous
          - name: "w3schools_tryit"
            url: "https://www.w3schools.com/html/tryit.asp?filename=tryhtml_default"
            goal: "Test HTML editor"
            
          - name: "jquery_ui_demos"
            url: "https://jqueryui.com/demos/"
            goal: "Test jQuery UI components"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Create project config
        run: |
          mkdir -p projects/ci_${{ matrix.website.name }}
          cat > projects/ci_${{ matrix.website.name }}/config.json << 'EOF'
          {
            "project_name": "ci_${{ matrix.website.name }}",
            "target_url": "${{ matrix.website.url }}",
            "goal": "${{ matrix.website.goal }}",
            "headless": true
          }
          EOF

      - name: Run Deep Explorer (3-5 Scenarios)
        id: explorer
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PYTHONPATH: .
        run: |
          # Use --deep for comprehensive regression suite
          python orchestrator.py --project projects/ci_${{ matrix.website.name }} --deep --force
        continue-on-error: true

      - name: Check Results Generated
        run: |
          RESULT_FILE="projects/ci_${{ matrix.website.name }}/execution.json"
          if [ -f "$RESULT_FILE" ]; then
            echo "âœ… Results generated successfully: $RESULT_FILE"
            cat "$RESULT_FILE" | jq '.scenarios | length' || echo "Result file exists"
          else
            echo "âŒ No result file found at $RESULT_FILE"
            exit 1
          fi

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-failure-logs
          path: |
            projects/ci_${{ matrix.website.name }}/*.log
            projects/ci_${{ matrix.website.name }}/.checkpoint.json
          retention-days: 7

      - name: Upload execution results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-execution-results
          path: |
            projects/ci_${{ matrix.website.name }}/execution.json
            projects/ci_${{ matrix.website.name }}/workflow.json
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: test-websites-deep
    if: always()
    
    steps:
      - name: Test Summary
        run: |
          echo "## ðŸ§ª Deep Explorer CI - 20 Website Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested 20 websites with **Deep Explorer Mode** (3-5 regression scenarios each)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.test-websites-deep.result }}" >> $GITHUB_STEP_SUMMARY
