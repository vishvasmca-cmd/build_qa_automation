name: CI - Golden Path E2E Suite

on:
  workflow_dispatch:

jobs:
  test-websites-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    strategy:
      fail-fast: false
      max-parallel: 1  # Sequential execution to ensure stability
      matrix:
        website:
          - name: saucedemo_e2e
            url: "https://www.saucedemo.com/"
            goal: "Login as 'standard_user'/'secret_sauce', add 'Backpack' to cart, checkout with zip='90210', verify order confirmation"
            
          - name: automationexercise_e2e
            url: "https://www.automationexercise.com/"
            goal: "Click 'Products', click FIRST product, add to cart, verify cart shows 1 item"
            
          - name: demoblaze_e2e
            url: "https://www.demoblaze.com/"
            goal: "Browse products and test purchase flow"
            
          - name: rahulshetty_e2e
            url: "https://rahulshettyacademy.com/seleniumPractise/"
            goal: "Search for 'Brocolli', add FIRST result to cart, click cart icon, verify checkout button visible"
            
          - name: the_internet_login
            url: "https://the-internet.herokuapp.com/login"
            goal: "Login with tomsmith/SuperSecretPassword!, verify secret area is visible"
            
          - name: parabank_register
            url: "https://parabank.parasoft.com/parabank/register.htm"
            goal: "Register a new user with random data and verify success message"


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Create project config
        run: |
          mkdir -p projects/ci_${{ matrix.website.name }}
          cat > projects/ci_${{ matrix.website.name }}/config.json << 'EOF'
          {
            "project_name": "ci_${{ matrix.website.name }}",
            "target_url": "${{ matrix.website.url }}",
            "goal": "${{ matrix.website.goal }}",
            "headless": true
          }
          EOF

      - name: Run Deep Explorer (3-5 Scenarios)
        id: explorer
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PYTHONPATH: .
        run: |
          # Discovery mode skip: No --deep flag
          python orchestrator.py --project projects/ci_${{ matrix.website.name }} --force
        continue-on-error: true

      - name: Check Results Generated
        run: |
          RESULT_FILE="projects/ci_${{ matrix.website.name }}/execution.json"
          if [ -f "$RESULT_FILE" ]; then
            echo "âœ… Results generated successfully: $RESULT_FILE"
            cat "$RESULT_FILE" | jq '.scenarios | length' || echo "Result file exists"
          else
            echo "âŒ No result file found at $RESULT_FILE"
            exit 1
          fi

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-failure-logs
          path: |
            projects/ci_${{ matrix.website.name }}/*.log
            projects/ci_${{ matrix.website.name }}/.checkpoint.json
          retention-days: 7

      - name: Upload execution results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-execution-results
          path: |
            projects/ci_${{ matrix.website.name }}/execution.json
            projects/ci_${{ matrix.website.name }}/workflow.json
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: test-websites-e2e
    if: always()
    
    steps:
      - name: Test Summary
        run: |
          echo "## ðŸ§ª Deep Explorer CI - 20 Website Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested 20 websites with **Deep Explorer Mode** (3-5 regression scenarios each)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.test-websites-deep.result }}" >> $GITHUB_STEP_SUMMARY
