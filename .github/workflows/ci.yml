name: CI - Golden Path E2E Suite

on:
  workflow_dispatch:

jobs:
  test-websites-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    strategy:
      fail-fast: false
      max-parallel: 1  # Sequential execution to ensure stability
      matrix:
        website:
          - name: saucedemo_e2e
            url: "https://www.saucedemo.com/"
            goal: "Login as 'standard_user'/'secret_sauce', add 'Backpack' to cart, checkout with zip='90210', verify order confirmation"
            
          - name: automationexercise_e2e
            url: "https://www.automationexercise.com/"
            goal: "Click 'Products', click FIRST product, add to cart, verify cart shows 1 item"
            
          - name: demoblaze_e2e
            url: "https://www.demoblaze.com/"
            goal: "Browse products and test purchase flow"
            
          - name: rahulshetty_e2e
            url: "https://rahulshettyacademy.com/seleniumPractise/"
            goal: "Search for 'Brocolli', add FIRST result to cart, click cart icon, verify checkout button visible"
            
          - name: the_internet_login
            url: "https://the-internet.herokuapp.com/login"
            goal: "Login with tomsmith/SuperSecretPassword!, verify secret area is visible"
            
          - name: parabank_register
            url: "https://parabank.parasoft.com/parabank/register.htm"
            goal: "Register a new user with random data and verify success message"
            
          - name: ultimateqa_automation
            url: "https://ultimateqa.com/automation"
            goal: "Navigate to 'Big page with many elements', click 'Buttons' section, click any button, verify interaction"
            
          - name: webdriveruniversity_contact
            url: "http://webdriveruniversity.com/Contact-Us/contactus.html"
            goal: "Fill contact form with name, email and message, click submit, verify success message"
            
          - name: uitestingplayground_ajax
            url: "http://uitestingplayground.com/ajax"
            goal: "Click the AJAX trigger button, wait for the response label to appear, verify its text"
            
          - name: demoqa_elements
            url: "https://demoqa.com/text-box"
            goal: "Fill the text box form with name and email, click submit, verify output matches input"
            
          - name: qaplayground_dynamic_table
            url: "https://qaplayground.dev/apps/dynamic-table/"
            goal: "Find the CPU usage of 'Chrome' process in the table and assert it is a percentage"
            
          - name: swaglabs_inventory
            url: "https://www.saucedemo.com/inventory.html"
            goal: "Add 'Bolt T-Shirt' and 'Onesie' to cart, verify cart badge shows '2'"
            
          - name: automationteststore_login
            url: "https://automationteststore.com/index.php?rt=account/login"
            goal: "Identify the 'Register' and 'Login' options, try login with invalid creds, verify error"
            
          - name: acme_banking_demo
            url: "https://demo.applitools.com/"
            goal: "Login to the demo banking portal, verify the total balance is visible and non-zero"
            
          - name: letcode_edit
            url: "https://letcode.in/edit"
            goal: "Type 'AI Tester' in the full name field, append text to another field, verify values"
            
          - name: formy_autocomplete
            url: "https://formy-project.herokuapp.com/autocomplete"
            goal: "Type an address in the search box, select the first suggestion, verify field fills"
            
          - name: bookstore_search
            url: "https://automationbookstore.dev/"
            goal: "Search for 'Java', verify at least one book related to Java is visible"
            
          - name: practice_expand_collapsible
            url: "https://webdriveruniversity.com/Accordion/index.html"
            goal: "Click on 'Manual Testing' accordion, verify the hidden text becomes visible"
            
          - name: qaplayground_tags_input
            url: "https://qaplayground.dev/apps/tags-input/"
            goal: "Add a new tag 'Playwright', verify it appears in the list of tags"
            
          - name: magento_luma_search
            url: "https://magento.softwaretestingboard.com/"
            goal: "Search for 'Breathe-Easy Tank', click the first result, select size and add to cart"


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Create project config
        run: |
          mkdir -p projects/ci_${{ matrix.website.name }}
          cat > projects/ci_${{ matrix.website.name }}/config.json << 'EOF'
          {
            "project_name": "ci_${{ matrix.website.name }}",
            "target_url": "${{ matrix.website.url }}",
            "goal": "${{ matrix.website.goal }}",
            "headless": true
          }
          EOF

      - name: Run Deep Explorer (3-5 Scenarios)
        id: explorer
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PYTHONPATH: .
        run: |
          # Discovery mode skip: No --deep flag
          python orchestrator.py --project projects/ci_${{ matrix.website.name }} --force
        continue-on-error: true

      - name: Check Results Generated
        run: |
          RESULT_FILE="projects/ci_${{ matrix.website.name }}/execution.json"
          if [ -f "$RESULT_FILE" ]; then
            echo "âœ… Results generated successfully: $RESULT_FILE"
            cat "$RESULT_FILE" | jq '.scenarios | length' || echo "Result file exists"
          else
            echo "âŒ No result file found at $RESULT_FILE"
            exit 1
          fi

      - name: Commit Learned Knowledge
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "AI Learner"
          git config --global user.email "ai-learner@github-actions"
          
          # Ensure directories exist so git commands don't fail
          mkdir -p knowledge/ sites/ datasets/
          
          # Stash changes if any exist to allow clean pull/rebase
          CHANGED=$(git status --porcelain knowledge/ datasets/ | wc -l)
          if [ "$CHANGED" -gt 0 ]; then
            git add knowledge/ datasets/
            git stash
            echo "STASHED=true" >> $GITHUB_ENV
          fi
          
          # Pull latest to avoid conflict
          git pull origin main --rebase || echo "Pull failed, proceeding..."
          
          # Restore stashed changes
          if [ "${{ env.STASHED }}" == "true" ] || [ "$STASHED_LOCALLY" == "true" ]; then
            # Small hack to handle local vs env var
            git stash pop || echo "Stash pop failed - resolving..."
          fi
          
          # Final add and check
          git add knowledge/ datasets/
          if [[ -n $(git status --porcelain knowledge/ datasets/) ]]; then
            git commit -m "ðŸ§  AI Update: Learned new locators and training data for ${{ matrix.website.name }}"
            
            # Retry push to handle concurrent CI runs
            for i in {1..5}; do
              git push origin HEAD:main && break
              echo "Push failed, retrying in 5s ($i/5)..."
              sleep 5
              git pull origin main --rebase
            done
            
            echo "âœ… Knowledge base updated in repository."
          else
            echo "â„¹ï¸ No new knowledge learned in this run."
          fi

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-failure-logs
          path: |
            projects/ci_${{ matrix.website.name }}/*.log
            projects/ci_${{ matrix.website.name }}/.checkpoint.json
          retention-days: 7

      - name: Upload execution results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.website.name }}-execution-results
          path: |
            projects/ci_${{ matrix.website.name }}/execution.json
            projects/ci_${{ matrix.website.name }}/workflow.json
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: test-websites-e2e
    if: always()
    
    steps:
      - name: Test Summary
        run: |
          echo "## ðŸ§ª Deep Explorer CI - 20 Website Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested 20 websites with **Deep Explorer Mode** (3-5 regression scenarios each)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.test-websites-e2e.result }}" >> $GITHUB_STEP_SUMMARY
