name: ðŸš€ Autonomous Regression Suite - 100 Sites

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual trigger
    inputs:
      site_count:
        description: 'Number of sites to test (max 100)'
        required: false
        default: '10'

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-matrix:
    name: ðŸ“‹ Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate site matrix
        id: set-matrix
        run: |
          SITE_COUNT=${{ github.event.inputs.site_count || 100 }}
          # Read sites from targets file, filter out comments and empty lines
          SITES=$(grep -v '^#' .github/regression_targets.txt | grep -v '^$' | head -n $SITE_COUNT | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=${SITES}" >> $GITHUB_OUTPUT

  autonomous-test:
    name: ðŸ¤– Test ${{ matrix.site }}
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        site: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium --with-deps
      
      - name: ðŸ§ª Run Autonomous Test Generation
        id: test
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          SITE_NAME=$(echo "${{ matrix.site }}" | sed 's/[^a-zA-Z0-9]/_/g')
          echo "SITE_NAME=${SITE_NAME}" >> $GITHUB_ENV
          PROJECT_DIR="projects/${SITE_NAME}_regression"
          
          # Create project config
          mkdir -p $PROJECT_DIR
          cat > $PROJECT_DIR/config.json <<EOF
          {
            "target_url": "${{ matrix.site }}",
            "project_name": "${SITE_NAME}_regression",
            "domain": "general",
            "testing_type": "regression",
            "workflow_description": "Autonomous smoke test: Navigate site, explore main features, verify key elements",
            "paths": {
              "trace": "$PROJECT_DIR/outputs/trace.json",
              "test": "$PROJECT_DIR/tests/e2e/test_main.py",
              "report": "$PROJECT_DIR/outputs/report.html"
            }
          }
          EOF
          
          # Run the autonomous pipeline
          echo "ðŸš€ Starting autonomous test for ${{ matrix.site }}"
          python trigger_agent.py $PROJECT_DIR/config.json 2>&1 | tee test_log.txt
          
          # Generate POM structure and files
          if [ -f "$PROJECT_DIR/outputs/trace.json" ]; then
            python core/pom_generator.py $PROJECT_DIR/outputs/trace.json
            python core/pom_template_engine.py $PROJECT_DIR/outputs/pom_structure.json
            
            # Run the generated test
            pytest $PROJECT_DIR/tests/e2e/test_main.py --html=$PROJECT_DIR/outputs/pytest_report.html --self-contained-html -v
          fi
      
      - name: ðŸ“Š Collect Metrics
        if: always()
        run: |
          SITE_NAME=$(echo "${{ matrix.site }}" | sed 's/[^a-zA-Z0-9]/_/g')
          PROJECT_DIR="projects/${SITE_NAME}_regression"
          
          # Create metrics JSON
          cat > metrics.json <<EOF
          {
            "site": "${{ matrix.site }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "pipeline_status": "${{ steps.test.outcome }}",
            "steps": {
              "exploration": $([ -f "$PROJECT_DIR/outputs/trace.json" ] && echo "true" || echo "false"),
              "pom_generation": $([ -f "$PROJECT_DIR/outputs/pom_structure.json" ] && echo "true" || echo "false"),
              "test_creation": $([ -f "$PROJECT_DIR/pages/*.py" ] && echo "true" || echo "false"),
              "test_execution": "$(grep -q 'passed' test_log.txt && echo 'passed' || echo 'failed')"
            },
            "artifacts": {
              "trace_size": $([ -f "$PROJECT_DIR/outputs/trace.json" ] && stat -c%s "$PROJECT_DIR/outputs/trace.json" || echo 0),
              "elements_discovered": $([ -f "$PROJECT_DIR/outputs/trace.json" ] && jq '.trace | length' "$PROJECT_DIR/outputs/trace.json" || echo 0),
              "pages_generated": $(ls $PROJECT_DIR/pages/*.py 2>/dev/null | wc -l)
            }
          }
          EOF
          
          mkdir -p training_data
          cp metrics.json training_data/${SITE_NAME}_metrics.json
      
      - name: ðŸ“¤ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.SITE_NAME }}
          path: |
            projects/*/outputs/**
            projects/*/pages/**
            projects/*/tests/**
            test_log.txt
            metrics.json
          retention-days: 30
      
      - name: ðŸ“¤ Upload Training Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-data-${{ env.SITE_NAME }}
          path: training_data/
          retention-days: 90

  aggregate-results:
    name: ðŸ“ˆ Aggregate & Commit Results
    needs: autonomous-test
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: ðŸ“Š Aggregate Training Data
        run: |
          mkdir -p knowledge/training_runs
          RUN_DIR="knowledge/training_runs/run_$(date +%Y%m%d_%H%M%S)"
          mkdir -p $RUN_DIR
          
          # Combine all metrics
          find artifacts/training-data-* -name "*_metrics.json" -exec cat {} \; | jq -s '.' > $RUN_DIR/combined_metrics.json
          
          # Generate summary report
          python -c "
          import json
          import sys
          from datetime import datetime
          
          with open('$RUN_DIR/combined_metrics.json') as f:
              data = json.load(f)
          
          total = len(data)
          passed = sum(1 for d in data if d['steps'].get('test_execution') == 'passed')
          explored = sum(1 for d in data if d['steps'].get('exploration'))
          pom_gen = sum(1 for d in data if d['steps'].get('pom_generation'))
          
          report = f'''# Regression Test Run Report
          
          **Run ID:** ${{ github.run_id }}
          **Timestamp:** {datetime.utcnow().isoformat()}
          **Commit:** ${{ github.sha }}
          
          ## Summary
          - **Total Sites:** {total}
          - **Exploration Success:** {explored}/{total} ({explored/total*100:.1f}%)
          - **POM Generation Success:** {pom_gen}/{total} ({pom_gen/total*100:.1f}%)
          - **Tests Passed:** {passed}/{total} ({passed/total*100:.1f}%)
          
          ## Success Rate
          - Pipeline Completion: {(pom_gen/total*100):.1f}%
          - End-to-End Success: {(passed/total*100):.1f}%
          
          ## Training Data
          - Location: knowledge/training_runs/run_*
          - Artifacts: {total} sites analyzed
          - Ready for model improvement
          '''
          
          with open('$RUN_DIR/README.md', 'w') as f:
              f.write(report)
          
          print(report)
          " | tee $RUN_DIR/summary.txt
      
      - name: ðŸ”„ Commit Training Data
        run: |
          git config user.name "Autonomous Testing Bot"
          git config user.email "bot@example.com"
          git add knowledge/training_runs/
          git commit -m "feat(training): Add regression run data from ${{ github.run_id }}
          
          - Tested sites from automated regression suite
          - Collected exploration traces and POM generation metrics
          - Data ready for continuous learning pipeline
          
          Run ID: ${{ github.run_id }}
          Commit: ${{ github.sha }}" || echo "No changes to commit"
      
      - name: ðŸš€ Push Changes
        run: |
          git push origin main || echo "Nothing to push"
